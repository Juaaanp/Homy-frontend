<app-header></app-header>

<div class="bg-light min-vh-100">
  @if (loading()) {
    <div class="loading-container">
      <div class="loader"></div>
      <p>Loading property...</p>
    </div>
  }

  @if (!loading() && property()) {
    <div class="property-container">
      <!-- Back Button -->
      <button class="back-button" (click)="goBack()">
        <lucide-icon [img]="ChevronLeft" [strokeWidth]="2"></lucide-icon>
        Back to Explore
      </button>

      <!-- Property Header -->
      <div class="property-header">
        <div class="header-left">
          <h1>{{ property()?.title }}</h1>
          <div class="property-meta">
            <div class="rating">
              <lucide-icon [img]="Star" [strokeWidth]="2"></lucide-icon>
              <span>{{ property()?.rating }}</span>
              <span class="reviews">({{ property()?.reviews }} reviews)</span>
            </div>
            <div class="location">
              <lucide-icon [img]="MapPin" [strokeWidth]="2"></lucide-icon>
              <span>{{ property()?.location }}</span>
            </div>
          </div>
        </div>
        <div class="header-actions">
          <button class="action-btn">
            <lucide-icon [img]="Share2" [strokeWidth]="2"></lucide-icon>
            Share
          </button>
          <button class="action-btn" (click)="toggleFavorite()" [class.favorited]="isFavorite()">
            <lucide-icon [img]="Heart" [strokeWidth]="2" [class.filled]="isFavorite()"></lucide-icon>
            {{ isFavorite() ? 'Saved' : 'Save' }}
          </button>
        </div>
      </div>

      <!-- Image Gallery -->
      <div class="image-gallery">
        <div class="img-fluid rounded">
          <img [src]="currentImage()" [alt]="property()?.title">
          <button class="nav-btn prev" (click)="previousImage()">
            <lucide-icon [img]="ChevronLeft" [strokeWidth]="2"></lucide-icon>
          </button>
          <button class="nav-btn next" (click)="nextImage()">
            <lucide-icon [img]="ChevronRight" [strokeWidth]="2"></lucide-icon>
          </button>
        </div>
        <div class="thumbnails">
          @for (image of property()?.images; track $index) {
            <div class="col-3" 
                 [class.active]="selectedImageIndex() === $index"
                 (click)="selectImage($index)">
              <img [src]="image" [alt]="'Photo ' + ($index + 1)">
            </div>
          }
        </div>
      </div>

      <!-- Content Grid -->
      <div class="content-grid">
        <div class="col-lg-8">
          <!-- Property Info -->
          <section class="row">
            <h2>Property Details</h2>
            <div class="specs">
              <div class="spec-item">
                <lucide-icon [img]="Users" [strokeWidth]="2"></lucide-icon>
                <span>{{ property()?.guests }} guests</span>
              </div>
              <div class="spec-item">
                <lucide-icon [img]="Bed" [strokeWidth]="2"></lucide-icon>
                <span>{{ property()?.bedrooms }} bedrooms</span>
              </div>
              <div class="spec-item">
                <lucide-icon [img]="Bath" [strokeWidth]="2"></lucide-icon>
                <span>{{ property()?.bathrooms }} bathrooms</span>
              </div>
            </div>
          </section>

          <div class="divider"></div>

          <!-- Description -->
          <section class="description-section">
            <h3>About this place</h3>
            <p>{{ property()?.description }}</p>
          </section>

          <div class="divider"></div>

          <!-- Amenities -->
          <section class="amenities-section">
            <h3>What this place offers</h3>
            <div class="row g-3">
              @for (amenity of property()?.amenities; track amenity) {
                <div class="col-6 col-md-4">
                  <lucide-icon [img]="Wifi" [strokeWidth]="2"></lucide-icon>
                  <span>{{ amenity }}</span>
                </div>
              }
            </div>
          </section>

          <div class="divider"></div>

          <!-- Location -->
          <section class="location-section">
            <h3>Location</h3>
            <div class="location-info">
              <lucide-icon [img]="MapPin" [strokeWidth]="2"></lucide-icon>
              <div>
                <p class="location-name">{{ property()?.location }}</p>
                <p class="location-city">{{ property()?.city }}, {{ property()?.country }}</p>
              </div>
            </div>
            @if (property()?.coordinates?.lat && property()?.coordinates?.lng) {
              <div class="map-wrapper">
                <app-map 
                  [latitude]="property()?.coordinates?.lat" 
                  [longitude]="property()?.coordinates?.lng"
                  [title]="property()?.title">
                </app-map>
              </div>
            }
          </section>

          <div class="divider"></div>

          <!-- Comments Section -->
          <section class="comments-section">
            <h3>Reviews</h3>
            
            @if (loadingComments()) {
              <p>Loading reviews...</p>
            } @else if (comments().length === 0) {
              <p class="no-comments">No reviews yet. Be the first to review this property!</p>
            } @else {
              <div class="comments-list">
                @for (comment of comments(); track comment.id) {
                  <div class="comment-item">
                    <div class="comment-header">
                      <div class="comment-author">
                        <strong>{{ comment.guestName }}</strong>
                        <div class="comment-rating">
                          @for (star of [1,2,3,4,5]; track star) {
                            <lucide-icon 
                              [img]="Star" 
                              [strokeWidth]="2"
                              [class.filled]="star <= comment.rate"
                              class="star-icon">
                            </lucide-icon>
                          }
                        </div>
                      </div>
                      <span class="comment-date">{{ formatDate(comment.createdAt) }}</span>
                    </div>
                    <p class="comment-content">{{ comment.content }}</p>
                    
                    @if (comment.hostReply) {
                      <div class="host-reply">
                        <strong>Host response:</strong>
                        <p>{{ comment.hostReply }}</p>
                      </div>
                    } @else if (isHost()) {
                      <button class="reply-btn" (click)="showReplyForm(comment)">Reply</button>
                    }
                  </div>
                }
              </div>
            }
          </section>
        </div>

        <!-- Booking Sidebar -->
        <div class="booking-sidebar">
          <div class="card border-0 shadow sticky-top">
            <div class="booking-header">
              <div class="price">
                <span class="amount">${{ property()?.price }}</span>
                <span class="period">/ night</span>
              </div>
              <div class="rating">
                <lucide-icon [img]="Star" [strokeWidth]="2"></lucide-icon>
                <span>{{ property()?.rating }}</span>
              </div>
            </div>

            <div class="">
              <div class="date-group">
                <div class="input-group">
                  <label>Check-in</label>
                  <input type="date" 
                         [value]="checkInDate()" 
                         (change)="checkInDate.set($any($event.target).value)"
                         [min]="getTodayDate()">
                </div>
                <div class="input-group">
                  <label>Check-out</label>
                  <input type="date" 
                         [value]="checkOutDate()" 
                         (change)="checkOutDate.set($any($event.target).value)"
                         [min]="checkInDate()">
                </div>
              </div>

              <div class="input-group">
                <label>Guests</label>
                <input type="number" 
                       [value]="guests()" 
                       (change)="guests.set(+$any($event.target).value)"
                       [min]="1" 
                       [max]="property()?.guests">
              </div>

              <button class="book-btn" (click)="bookNow()">Reserve</button>

              @if (nights() > 0) {
                <div class="price-breakdown">
                  <div class="price-row">
                    <span>${{ property()?.price }} x {{ nights() }} nights</span>
                    <span>${{ subtotal() }}</span>
                  </div>
                  <div class="price-row">
                    <span>Service fee</span>
                    <span>${{ serviceFee() }}</span>
                  </div>
                  <div class="price-row">
                    <span>Cleaning fee</span>
                    <span>${{ cleaningFee() }}</span>
                  </div>
                  <div class="divider-sm"></div>
                  <div class="price-row total">
                    <span>Total</span>
                    <span>${{ total() }}</span>
                  </div>
                </div>
              }
            </div>
          </div>
        </div>
      </div>
    </div>
  }

  @if (!loading() && !property()) {
    <div class="error-container" style="display: flex; justify-content: center; align-items: center; min-height: 60vh; padding: 2rem;">
      <div class="error-content" style="text-align: center; max-width: 500px;">
        <h1 style="font-size: 2rem; margin-bottom: 1rem; color: #333;">Property Not Found</h1>
        <p style="color: #666; margin-bottom: 2rem;">Unable to load property details. Please try again.</p>
        <button class="btn-primary" (click)="goBack()" style="padding: 0.75rem 2rem; background: #f97316; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
          Back to Explore
        </button>
      </div>
    </div>
  }

</div>

<app-footer></app-footer>
