<app-header></app-header>

<div class="bg-light min-vh-100">
  @if (loading()) {
    <div class="loading-container">
      <div class="loader"></div>
      <p>Loading property...</p>
    </div>
  }

  @if (!loading() && property()) {
    <div class="property-container">
      <!-- Back Button -->
      <button class="back-button" (click)="goBack()">
        <lucide-icon [img]="ChevronLeft" [strokeWidth]="2"></lucide-icon>
        Back to Explore
      </button>

      <!-- Property Header -->
      <div class="property-header">
        <div class="header-left">
          <h1>{{ property()?.title }}</h1>
          <div class="property-meta">
            <div class="rating">
              <lucide-icon [img]="Star" [strokeWidth]="2"></lucide-icon>
              <span>{{ property()?.rating }}</span>
              <span class="reviews">({{ property()?.reviews }} reviews)</span>
            </div>
            <div class="location">
              <lucide-icon [img]="MapPin" [strokeWidth]="2"></lucide-icon>
              <span>{{ property()?.location }}</span>
            </div>
          </div>
        </div>
        <div class="header-actions">
          <button class="action-btn">
            <lucide-icon [img]="Share2" [strokeWidth]="2"></lucide-icon>
            Share
          </button>
          <button class="action-btn" (click)="toggleFavorite()" [class.favorited]="isFavorite()">
            <lucide-icon [img]="Heart" [strokeWidth]="2" [class.filled]="isFavorite()"></lucide-icon>
            {{ isFavorite() ? 'Saved' : 'Save' }}
          </button>
        </div>
      </div>

      <!-- Image Gallery -->
      <div class="image-gallery">
        <div class="img-fluid rounded">
          <img [src]="currentImage()" [alt]="property()?.title">
          <button class="nav-btn prev" (click)="previousImage()">
            <lucide-icon [img]="ChevronLeft" [strokeWidth]="2"></lucide-icon>
          </button>
          <button class="nav-btn next" (click)="nextImage()">
            <lucide-icon [img]="ChevronRight" [strokeWidth]="2"></lucide-icon>
          </button>
        </div>
        <div class="thumbnails">
          @for (image of property()?.images; track $index) {
            <div class="col-3" 
                 [class.active]="selectedImageIndex() === $index"
                 (click)="selectImage($index)">
              <img [src]="image" [alt]="'Photo ' + ($index + 1)">
            </div>
          }
        </div>
      </div>

      <!-- Content Grid -->
      <div class="content-grid">
        <div class="col-lg-8">
          <!-- Property Info -->
          <section class="row">
            <h2>Property Details</h2>
            <div class="specs">
              <div class="spec-item">
                <lucide-icon [img]="Users" [strokeWidth]="2"></lucide-icon>
                <span>{{ property()?.guests }} guests</span>
              </div>
              <div class="spec-item">
                <lucide-icon [img]="Bed" [strokeWidth]="2"></lucide-icon>
                <span>{{ property()?.bedrooms }} bedrooms</span>
              </div>
              <div class="spec-item">
                <lucide-icon [img]="Bath" [strokeWidth]="2"></lucide-icon>
                <span>{{ property()?.bathrooms }} bathrooms</span>
              </div>
            </div>
          </section>

          <div class="divider"></div>

          <!-- Description -->
          <section class="description-section">
            <h3>About this place</h3>
            <p>{{ property()?.description }}</p>
          </section>

          <div class="divider"></div>

          <!-- Amenities -->
          <section class="amenities-section">
            <h3>What this place offers</h3>
            <div class="row g-3">
              @for (amenity of property()?.amenities; track amenity) {
                <div class="col-6 col-md-4">
                  <lucide-icon [img]="Wifi" [strokeWidth]="2"></lucide-icon>
                  <span>{{ amenity }}</span>
                </div>
              }
            </div>
          </section>

          <div class="divider"></div>

          <!-- Location -->
          <section class="location-section">
            <h3>Location</h3>
            <div class="location-info">
              <lucide-icon [img]="MapPin" [strokeWidth]="2"></lucide-icon>
              <div>
                <p class="location-name">{{ property()?.location }}</p>
                <p class="location-city">{{ property()?.city }}, {{ property()?.country }}</p>
              </div>
            </div>
            @if (property()?.coordinates?.lat && property()?.coordinates?.lng) {
              <div class="map-wrapper">
                <app-map 
                  [latitude]="property()?.coordinates?.lat" 
                  [longitude]="property()?.coordinates?.lng"
                  [title]="property()?.title">
                </app-map>
              </div>
            }
          </section>
        </div>

        <!-- Booking Sidebar -->
        <div class="booking-sidebar">
          <div class="card border-0 shadow sticky-top">
            <div class="booking-header">
              <div class="price">
                <span class="amount">${{ property()?.price }}</span>
                <span class="period">/ night</span>
              </div>
              <div class="rating">
                <lucide-icon [img]="Star" [strokeWidth]="2"></lucide-icon>
                <span>{{ property()?.rating }}</span>
              </div>
            </div>

            <div class="">
              <div class="date-group">
                <div class="input-group">
                  <label>Check-in</label>
                  <input type="date" 
                         [value]="checkInDate()" 
                         (change)="checkInDate.set($any($event.target).value)"
                         [min]="getTodayDate()">
                </div>
                <div class="input-group">
                  <label>Check-out</label>
                  <input type="date" 
                         [value]="checkOutDate()" 
                         (change)="checkOutDate.set($any($event.target).value)"
                         [min]="checkInDate()">
                </div>
              </div>

              <div class="input-group">
                <label>Guests</label>
                <input type="number" 
                       [value]="guests()" 
                       (change)="guests.set(+$any($event.target).value)"
                       [min]="1" 
                       [max]="property()?.guests">
              </div>

              <button class="book-btn" (click)="bookNow()">Reserve</button>

              @if (nights() > 0) {
                <div class="price-breakdown">
                  <div class="price-row">
                    <span>${{ property()?.price }} x {{ nights() }} nights</span>
                    <span>${{ subtotal() }}</span>
                  </div>
                  <div class="price-row">
                    <span>Service fee</span>
                    <span>${{ serviceFee() }}</span>
                  </div>
                  <div class="price-row">
                    <span>Cleaning fee</span>
                    <span>${{ cleaningFee() }}</span>
                  </div>
                  <div class="divider-sm"></div>
                  <div class="price-row total">
                    <span>Total</span>
                    <span>${{ total() }}</span>
                  </div>
                </div>
              }
            </div>
          </div>
        </div>
      </div>
    </div>
  }

  @if (!loading() && !property()) {
    <div class="error-container">
      <div class="error-content">
        <div class="error-icon-wrapper">
          <lucide-icon [img]="MapPin" class="error-icon"></lucide-icon>
        </div>
        <h1 class="error-title">Property Not Found</h1>
        <p class="error-message">
          We couldn't find the property you're looking for. It may have been removed or the link is incorrect.
        </p>
        <div class="error-actions">
          <button class="btn-primary" (click)="goBack()">
            <lucide-icon [img]="ChevronLeft" [strokeWidth]="2"></lucide-icon>
            Back to Explore
          </button>
          <button class="btn-secondary" routerLink="/">
            <lucide-icon [img]="Home" [strokeWidth]="2"></lucide-icon>
            Go to Home
          </button>
        </div>
      </div>
    </div>
  }
</div>

<app-footer></app-footer>
