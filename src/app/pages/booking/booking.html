<div class="min-h-screen bg-white">
  <app-header></app-header>

  <main class="main-container">
    <!-- Stepper -->
    <div class="stepper">
      <div [class.stepper-badge-active]="step() >= 1" class="stepper-badge">
        1. Dates & Guests
      </div>
      <div class="stepper-line"></div>
      <div [class.stepper-badge-active]="step() >= 2" class="stepper-badge">
        2. Guest details
      </div>
      <div class="stepper-line"></div>
      <div [class.stepper-badge-active]="step() >= 3" class="stepper-badge">
        3. Payment & confirm
      </div>
    </div>

    <!-- Content grid -->
    <div class="content-grid">
      <div class="content-main">
        <!-- STEP 1: Dates & Guests -->
        <section *ngIf="step() === 1" class="card">
          <h2 class="card-title">
            <lucide-icon name="calendar" class="title-icon"></lucide-icon>
            Dates & Guests
          </h2>
          <p class="card-subtitle">
            Minimum 1 night ¬∑ No past dates ¬∑ Max capacity {{ maxGuests() }} guests
          </p>

          <div class="form-grid">
            <label class="form-label">
              <span class="label-text">Check-in</span>
              <input
                type="date"
                [min]="today"
                [ngModel]="checkIn()"
                (ngModelChange)="checkIn.set($event)"
                class="form-input"
              />
            </label>

            <label class="form-label">
              <span class="label-text">Check-out</span>
              <input
                type="date"
                [min]="checkIn() || today"
                [ngModel]="checkOut()"
                (ngModelChange)="checkOut.set($event)"
                class="form-input"
              />
            </label>

            <label class="form-label">
              <span class="label-text">Guests</span>
              <input
                type="number"
                [min]="1"
                [max]="maxGuests()"
                [ngModel]="guests()"
                (ngModelChange)="guests.set($event)"
                class="form-input"
              />
            </label>
          </div>

          <div class="nights-info" *ngIf="!loading()">
            <span class="font-medium">{{ nights() }}</span>
            night{{ nights() === 1 ? '' : 's' }} ¬∑ ${{ nightlyPrice() }}/night
          </div>
          <div class="nights-info" *ngIf="loading()">
            <span>Loading property details...</span>
          </div>

          <div *ngIf="s1Error()" class="error-box">
            <lucide-icon name="info" class="error-icon"></lucide-icon>
            <span>{{ s1Error() }}</span>
          </div>

          <div class="button-row justify-end">
            <app-button (click)="validateStep1()" class="btn-primary">
              Continue
              <lucide-icon name="arrow-right" class="btn-icon-right"></lucide-icon>
            </app-button>
          </div>
        </section>

        <!-- STEP 2: Guest Details -->
        <section *ngIf="step() === 2" class="card">
          <h2 class="card-title">Guest details</h2>
          <p class="card-subtitle">
            We'll share these with the host to coordinate your stay.
          </p>

          <div class="form-grid-2">
            <label class="form-label">
              <span class="label-text">Full name</span>
              <input
                type="text"
                placeholder="John Doe"
                [ngModel]="fullName()"
                (ngModelChange)="fullName.set($event)"
                class="form-input"
              />
            </label>

            <label class="form-label">
              <span class="label-text">Email</span>
              <input
                type="email"
                placeholder="john@email.com"
                [ngModel]="email()"
                (ngModelChange)="email.set($event)"
                class="form-input"
              />
            </label>

            <label class="form-label">
              <span class="label-text">Phone</span>
              <input
                type="tel"
                placeholder="+57 300 123 4567"
                [ngModel]="phone()"
                (ngModelChange)="phone.set($event)"
                class="form-input"
              />
            </label>

            <label class="form-label full-width">
              <span class="label-text">Notes (optional)</span>
              <textarea
                placeholder="Any arrival details or requests for the host..."
                [ngModel]="notes()"
                (ngModelChange)="notes.set($event)"
                class="form-input"
                rows="3"
              ></textarea>
            </label>
          </div>

          <div *ngIf="s2Error()" class="error-box">
            <lucide-icon name="info" class="error-icon"></lucide-icon>
            <span>{{ s2Error() }}</span>
          </div>

          <div class="button-row">
            <app-button variant="outline" (click)="goBack(1)">
              <lucide-icon name="chevron-left" class="btn-icon-left"></lucide-icon>
              Back
            </app-button>
            <app-button (click)="validateStep2()" class="btn-primary">
              Continue
              <lucide-icon name="arrow-right" class="btn-icon-right"></lucide-icon>
            </app-button>
          </div>
        </section>

        <!-- STEP 3: Payment & Confirmation -->
        <section *ngIf="step() === 3" class="card">
          <h2 class="card-title">
            <lucide-icon name="wallet" class="title-icon"></lucide-icon>
            Payment (Simulated) & Confirmation
          </h2>
          <p class="card-subtitle">
            <strong>‚ö†Ô∏è Payment is fully simulated - No real charges will be made.</strong><br>
            This is a demo payment form. Your booking will be confirmed without any actual payment processing.
          </p>

          <div *ngIf="!confirmed()">
            <div class="form-grid-2">
              <label class="form-label">
                <span class="label-text">Name on card</span>
                <input
                  type="text"
                  placeholder="John Doe"
                  [ngModel]="cardName()"
                  (ngModelChange)="cardName.set($event)"
                  class="form-input"
                />
              </label>

              <label class="form-label">
                <span class="label-text">Card number</span>
                <input
                  type="text"
                  inputmode="numeric"
                  placeholder="4242 4242 4242 4242"
                  [ngModel]="cardNumber()"
                  (ngModelChange)="cardNumber.set($event)"
                  class="form-input"
                />
              </label>

              <label class="form-label">
                <span class="label-text">Expiry</span>
                <input
                  type="text"
                  placeholder="MM/YY"
                  [ngModel]="cardExp()"
                  (ngModelChange)="cardExp.set($event)"
                  class="form-input"
                />
              </label>

              <label class="form-label">
                <span class="label-text">CVC</span>
                <input
                  type="text"
                  inputmode="numeric"
                  placeholder="123"
                  [ngModel]="cardCvc()"
                  (ngModelChange)="cardCvc.set($event)"
                  class="form-input"
                />
              </label>
            </div>

            <label class="checkbox-label" style="margin-bottom: 1.5rem;">
              <input
                type="checkbox"
                [ngModel]="agree()"
                (ngModelChange)="agree.set($event)"
                class="checkbox-input"
              />
              <span>
                ‚úÖ Acepto las pol√≠ticas de cancelaci√≥n y las reglas de la casa
                <span style="color: #666; font-size: 0.9em;">(El pago es simulado, no se realizar√°n cargos reales)</span>
              </span>
            </label>
            
            <div style="background: #fef3c7; border: 1px solid #fbbf24; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
              <p style="color: #92400e; font-size: 0.95rem; margin: 0; text-align: center;">
                <strong>‚ö†Ô∏è Pago Simulado:</strong> Haz clic en "Confirmar Reserva" para crear tu reserva. No se realizar√°n cargos reales.
              </p>
            </div>

            <div *ngIf="s3Error()" class="error-box">
              <lucide-icon name="info" class="error-icon"></lucide-icon>
              <span>{{ s3Error() }}</span>
            </div>

            <div class="button-row">
              <app-button variant="outline" (click)="goBack(2)">
                <lucide-icon name="chevron-left" class="btn-icon-left"></lucide-icon>
                Back
              </app-button>
              <app-button 
                (click)="confirmBooking()" 
                [disabled]="submitting() || !propertyId() || !userId()"
                class="btn-primary"
                style="min-width: 200px; font-size: 1.1rem; padding: 1rem 2rem;">
                <span *ngIf="!submitting()">
                  ‚úÖ Confirmar Reserva
                  <lucide-icon name="check-circle-2" class="btn-icon-right"></lucide-icon>
                </span>
                <span *ngIf="submitting()">
                  <lucide-icon name="loader-2" class="animate-spin"></lucide-icon>
                  Creando reserva...
                </span>
              </app-button>
            </div>
          </div>

          <!-- Reserva confirmada y guardada en la base de datos -->
          <div *ngIf="confirmed()" class="success-box" style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border: 2px solid #22c55e; border-radius: 12px; padding: 2rem; margin-top: 1.5rem;">
            <div class="success-content" style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
              <div style="background: #22c55e; border-radius: 50%; width: 64px; height: 64px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                <lucide-icon name="check-circle-2" style="color: white; width: 40px; height: 40px;"></lucide-icon>
              </div>
              <div>
                <h3 class="success-title" style="font-size: 1.5rem; font-weight: 700; color: #15803d; margin-bottom: 0.5rem;">‚úÖ Reserva Confirmada y Guardada!</h3>
                <p class="success-text" style="color: #166534; font-size: 1rem; line-height: 1.6;">
                  <strong>‚úÖ Tu reserva ha sido creada exitosamente y guardada en la base de datos.</strong><br>
                  <strong>üìß El host ha sido notificado por email.</strong><br>
                  <strong>üè† La propiedad est√° reservada para las fechas seleccionadas.</strong><br>
                  <strong>üë§ El host puede ver esta reserva en su panel de control.</strong>
                </p>
              </div>
            </div>
            
            <div style="background: white; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem; border: 1px solid #bbf7d0;">
              <h4 style="font-size: 1.1rem; font-weight: 600; color: #15803d; margin-bottom: 1rem;">üìã Detalles de la Reserva:</h4>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                <div>
                  <p style="color: #666; font-size: 0.9rem; margin-bottom: 0.25rem;">Propiedad:</p>
                  <p style="font-weight: 600; color: #333; font-size: 1rem;">{{ housing()?.title || 'N/A' }}</p>
                </div>
                <div>
                  <p style="color: #666; font-size: 0.9rem; margin-bottom: 0.25rem;">Check-in:</p>
                  <p style="font-weight: 600; color: #333; font-size: 1rem;">{{ checkIn() }}</p>
                </div>
                <div>
                  <p style="color: #666; font-size: 0.9rem; margin-bottom: 0.25rem;">Check-out:</p>
                  <p style="font-weight: 600; color: #333; font-size: 1rem;">{{ checkOut() }}</p>
                </div>
                <div>
                  <p style="color: #666; font-size: 0.9rem; margin-bottom: 0.25rem;">Hu√©spedes:</p>
                  <p style="font-weight: 600; color: #333; font-size: 1rem;">{{ guests() }}</p>
                </div>
                <div>
                  <p style="color: #666; font-size: 0.9rem; margin-bottom: 0.25rem;">Total (simulado):</p>
                  <p style="font-weight: 600; color: #333; font-size: 1rem;">${{ total().toLocaleString() }}</p>
                </div>
              </div>
            </div>
            
            <div style="background: #fef3c7; border: 1px solid #fbbf24; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
              <p style="color: #92400e; font-size: 0.9rem; margin: 0;">
                <strong>‚ö†Ô∏è Nota:</strong> El pago fue simulado. No se realizaron cargos reales. La reserva est√° activa y guardada en el sistema.
              </p>
            </div>
            
            <div class="success-button" style="display: flex; gap: 1rem; justify-content: center;">
              <app-button (click)="router.navigate(['/bookings'])" class="btn-primary" style="flex: 1;">
                <lucide-icon name="calendar" class="btn-icon-left"></lucide-icon>
                Ver Mis Reservas
              </app-button>
              <app-button variant="outline" (click)="router.navigate(['/explore'])" style="flex: 1;">
                Explorar M√°s
              </app-button>
            </div>
          </div>
        </section>
      </div>

      <!-- SUMMARY SIDEBAR -->
      <aside class="sidebar">
        <div class="sidebar-sticky">
          <div class="card border-0 shadow-sm sticky-top" *ngIf="!loading() && housing()">
            <h3 class="summary-title">{{ housing()?.title || 'Property' }}</h3>
            <p class="text-sm text-gray-600 mb-4">{{ housing()?.city || '' }}</p>
            <h3 class="summary-title">Price summary</h3>
            <div class="summary-rows">
              <div class="summary-row">
                <span>${{ nightlyPrice() }} x {{ nights() }} night{{ nights() === 1 ? '' : 's' }}</span>
                <span>${{ subtotal() }}</span>
              </div>
              <div class="summary-row">
                <span>Cleaning fee</span>
                <span>${{ cleaningFee() }}</span>
              </div>
              <div class="summary-row">
                <span>Service fee</span>
                <span>${{ serviceFee() }}</span>
              </div>
              <div class="summary-row">
                <span>Taxes</span>
                <span>${{ taxes() }}</span>
              </div>
              <div class="summary-divider"></div>
              <div class="summary-row summary-total">
                <span>Total</span>
                <span>${{ total() }}</span>
              </div>
            </div>
          </div>

          <div class="security-notice">
            <lucide-icon name="shield" class="security-icon"></lucide-icon>
            <p>
              <strong>‚ö†Ô∏è Simulated Payment:</strong> No real charges will be made. This is a demo booking system.
            </p>
          </div>
        </div>
      </aside>
    </div>
  </main>

  <app-footer></app-footer>
</div>
